name: MailAD VM Integration Tests

on:
  push:
    branches: [ master, development ]
  pull_request:
    branches: [ master, development ]
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      auth_file: ${{ steps.create_auth.outputs.auth_file }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create auth file
        id: create_auth
        run: |
          # Create a temporary auth file with credentials
          cat > .mailadmin.auth << EOF
          PASS='P@ssw0rd123!'
          
          # national user and credentials
          NACUSER="starf@mailad.cu"
          NACUSERPASSWD='N@tional123'
          
          # local user and credentials
          LOCUSER="pepa@mailad.cu"
          LOCUSERPASSWORD='L0cal123!'
          
          # Linux bind user password
          LDAPBINDPASSWD='B1ndP@ss123!'
          EOF
          
          # Base64 encode the file for passing between jobs
          AUTH_FILE=$(base64 -w 0 .mailadmin.auth)
          echo "auth_file=$AUTH_FILE" >> $GITHUB_OUTPUT
      
      - name: Upload repository
        uses: actions/upload-artifact@v4
        with:
          name: mailad-repo
          path: .

  dc:
    needs: setup
    runs-on: ubuntu-latest
    
    steps:
      - name: Download repository
        uses: actions/download-artifact@v4
        with:
          name: mailad-repo
          path: ${{ github.workspace }}/mailad
      
      - name: Setup auth file
        run: |
          echo "${{ needs.setup.outputs.auth_file }}" | base64 -d > ${{ github.workspace }}/mailad/.mailadmin.auth
          chmod 600 ${{ github.workspace }}/mailad/.mailadmin.auth
      
      - name: Set script permissions
        run: |
          cd ${{ github.workspace }}/mailad
          chmod +x scripts/*.sh
          chmod +x utils/*.sh
          chmod +x tests/*.sh
      
      - name: Run make conf
        run: |
          cd ${{ github.workspace }}/mailad
          sudo mkdir -p /etc/mailad
          sudo make conf
      
      - name: Configure hosts
        run: |
          echo "127.0.1.1 dc.mailad.cu  dc" | sudo tee -a /etc/hosts

          # Get local IP associated with the default gateway
          LOCAL_IP=$(ip route show default | awk '{print $3}')
          echo "$LOCAL_IP dc.mailad.cu  dc" | sudo tee -a /etc/hosts
          
          # Save IP for other jobs
          echo "$LOCAL_IP" > ${{ github.workspace }}/samba_ip.txt
      
      - name: Setup Samba AD
        run: |
          # export the default external DNS resolver
          export DNSFWD=1.1.1.1

          # install & configure Samba AD
          cd ${{ github.workspace }}/mailad
          chmod +x utils/samba_scaffold.sh
          sudo -E utils/samba_scaffold.sh
      
      - name: Upload Samba AD IP
        uses: actions/upload-artifact@v4
        with:
          name: samba-ad-ip
          path: ${{ github.workspace }}/samba_ip.txt

  mail:
    needs: [setup, dc]
    runs-on: ubuntu-latest
    
    steps:
      - name: Download repository
        uses: actions/download-artifact@v4
        with:
          name: mailad-repo
          path: ${{ github.workspace }}/mailad
      
      - name: Download Samba AD IP
        uses: actions/download-artifact@v4
        with:
          name: samba-ad-ip
          path: ${{ github.workspace }}/samba-ad-ip
      
      - name: Setup auth file
        run: |
          echo "${{ needs.setup.outputs.auth_file }}" | base64 -d > ${{ github.workspace }}/mailad/.mailadmin.auth
          chmod 600 ${{ github.workspace }}/mailad/.mailadmin.auth
      
      - name: Set script permissions
        run: |
          cd ${{ github.workspace }}/mailad
          chmod +x scripts/*.sh
          chmod +x utils/*.sh
          chmod +x tests/*.sh
      
      - name: Run make conf and change some vars
        run: |
          cd ${{ github.workspace }}/mailad
          sudo mkdir -p /etc/mailad
          sudo make conf
            
          # Update linux password for the ldap bind from the .mailad.auth file
          source ${{ github.workspace }}/mailad/.mailadmin.auth
          sudo sed -i "s/LDAPBINDPASSWD=.*/LDAPBINDPASSWD=${LDAPBINDPASSWD}/" /etc/mailad/mailad.conf
      
      - name: Configure hosts
        run: |
          SAMBA_AD_IP=$(cat ${{ github.workspace }}/samba-ad-ip/samba_ip.txt)
          echo "$SAMBA_AD_IP dc.mailad.cu dc" | sudo tee -a /etc/hosts

          # Get local IP associated with the default gateway
          LOCAL_IP=$(ip route show default | awk '{print $3}')
          echo "$LOCAL_IP mail.mailad.cu mail" | sudo tee -a /etc/hosts
          echo "127.0.1.1 mail.mailad.cu mail" | sudo tee -a /etc/hosts
          echo "$LOCAL_IP" > ${{ github.workspace }}/mailad_ip.txt
      
      - name: Install MailAD
        run: |
          cd ${{ github.workspace }}/mailad
          sudo make all
      
      - name: Upload MailAD Server IP
        uses: actions/upload-artifact@v4
        with:
          name: mailad-server-ip
          path: ${{ github.workspace }}/mailad_ip.txt

  test-client:
    needs: [setup, dc, mail]
    runs-on: ubuntu-latest
    
    steps:
      - name: Download repository
        uses: actions/download-artifact@v4
        with:
          name: mailad-repo
          path: ${{ github.workspace }}/mailad
      
      - name: Download Samba AD IP
        uses: actions/download-artifact@v4
        with:
          name: samba-ad-ip
          path: ${{ github.workspace }}/samba-ad-ip
      
      - name: Download MailAD Server IP
        uses: actions/download-artifact@v4
        with:
          name: mailad-server-ip
          path: ${{ github.workspace }}/mailad-server-ip
      
      - name: Setup auth file
        run: |
          echo "${{ needs.setup.outputs.auth_file }}" | base64 -d > ${{ github.workspace }}/mailad/.mailadmin.auth
          chmod 600 ${{ github.workspace }}/mailad/.mailadmin.auth
      
      - name: Set script permissions
        run: |
          cd ${{ github.workspace }}/mailad
          chmod +x scripts/*.sh
          chmod +x utils/*.sh
          chmod +x tests/*.sh
      
      - name: Run make conf
        run: |
          cd ${{ github.workspace }}/mailad
          sudo mkdir -p /etc/mailad
          sudo make conf
          
          # Copy mailad.conf to .mailad.auth as required by tests
          sudo cp /etc/mailad/mailad.conf ${{ github.workspace }}/mailad/.mailadmin.auth
      
      - name: Configure hosts
        run: |
          SAMBA_AD_IP=$(cat ${{ github.workspace }}/samba-ad-ip/samba_ip.txt)
          MAILAD_SERVER_IP=$(cat ${{ github.workspace }}/mailad-server-ip/mailad_ip.txt)
          
          echo "$SAMBA_AD_IP  dc.mailad.cu dc" | sudo tee -a /etc/hosts
          echo "$MAILAD_SERVER_IP mail.mailad.cu  mail" | sudo tee -a /etc/hosts
      
      - name: Install test dependencies
        run: |
          cd ${{ github.workspace }}/mailad
          sudo make test-deps

      - name: Run tests
        run: |
          cd ${{ github.workspace }}/mailad
          chmod +x tests/test.sh
          MAILAD_SERVER_IP=$(cat ${{ github.workspace }}/mailad-server-ip/mailad_ip.txt)
          sudo -E tests/test.sh $MAILAD_SERVER_IP

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: ${{ github.workspace }}/mailad/test.log
